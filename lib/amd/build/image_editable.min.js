define ("core/image_editable",["exports","core/ajax","core/croppie","core/str","core/templates","core/notification"],function(a,b,c,d,e,f){"use strict";Object.defineProperty(a,"__esModule",{value:!0});a.init=void 0;b=g(b);c=g(c);e=g(e);f=g(f);function g(a){return a&&a.__esModule?a:{default:a}}var h={actions:{confirm:"[data-action=\"confirm\"]",cancel:"[data-action=\"cancel\"]",cropimage:"[data-action=\"cropimage\"]",uploadimage:"[data-action=\"uploadimage\"]",deleteimage:"[data-action=\"deleteimage\"]"},regions:{imagehandler:"[data-region=\"imagehandler\"]",imagecontrols:"[data-region=\"imagecontrols\"]",alert:".alert",zoomslider:".cr-slider",editactions:"[data-region=\"editactions\"]",confirmactions:"[data-region=\"confirmactions\"]",ajaxing:"[data-region=\"ajaxing\"]",hiddenFormField:"[data-region=\"hiddenformfield\"]"},classes:{hidden:"d-none",saving:"saving",deleting:"deleting",disabled:"disabled",enabled:"js-enabled"}},i=function(a,b){return e.default.render("core/notification",{message:b,closebutton:!0,iswarning:!0}).then(function(b,c){e.default.prependNodeContents(a,b,c)})},j=function(a){var b=a.querySelector(h.regions.alert);if(b){b.remove()}},k=function(a,b){var c=a.querySelector(h.regions.ajaxing);if(b){c.classList.remove(h.classes.hidden)}else{c.classList.add(h.classes.hidden)}},l=function(a,b){var c=a.querySelector(h.actions.deleteimage);if(b){c.classList.add(h.classes.enabled);c.setAttribute("tabindex",0)}else{c.classList.remove(h.classes.enabled);c.setAttribute("tabindex",-1)}},m=function(a){var b=a.getAttribute("data-currentimage"),c=a.querySelector(h.actions.cropimage),d=a.querySelector(h.regions.confirmactions),e=a.querySelector(h.regions.editactions);if(b){c.classList.remove(h.classes.hidden);l(a,!0)}else{c.classList.add(h.classes.hidden);l(a,!1)}d.classList.add(h.classes.hidden);e.classList.remove(h.classes.hidden);j(a)},n=function(a){var c=b.default.call([{methodname:"core_update_image_editable",args:a}])[0].fail(f.default.exception);return c},o=function(a){var b=Math.floor(Math.log(a)/Math.log(1024));return 1*(a/Math.pow(1024,b)).toFixed(2)+" "+["B","kB","MB","GB","TB"][b]},p=function(a,b){a.style.backgroundImage="url(\""+b+"\")"},q=function(a,b,c){var d=a.querySelector(h.regions.confirmactions),e=a.querySelector(h.regions.editactions),f=a.querySelector(h.actions.confirm),g=f.cloneNode(!0);f.parentNode.replaceChild(g,f);b.done(function(a){g.innerHTML=a;d.classList.remove(h.classes.hidden);e.classList.add(h.classes.hidden);g.addEventListener("click",function(a){c();a.preventDefault()})});l(a,!1)},r=function(a,b){var c=a.querySelector(h.actions.cancel),d=c.cloneNode(!0);c.parentNode.replaceChild(d,c);d.addEventListener("click",function(a){b();a.preventDefault()})},s=function(a){var b=a.querySelector(h.regions.imagehandler),e=a.getAttribute("data-currentimage"),f=a.getAttribute("data-size"),g=new c.default(b,{enableExif:!0,viewport:{width:90*(f/100),height:90*(f/100),type:"square"}});g.bind({url:e});p(b,"");var j=a.querySelector(h.regions.zoomslider);j.classList.add("form-control-range");j.setAttribute("step",.01);if("rounded"===a.getAttribute("data-rounded")){a.querySelector(".cr-viewport").classList.add("cr-vp-circle")}q(a,(0,d.get_string)("cropimage","repository"),function(){g.result("base64").then(function(c){var d={imagedata:c.split("base64,")[1],imagefilename:"cropped.png",cropped:1,component:a.getAttribute("data-component"),filearea:a.getAttribute("data-filearea"),contextid:a.getAttribute("data-contextid"),draftitemid:a.getAttribute("data-draftitemid")};k(a,!0);n({params:d}).then(function(d){if(d.success){p(b,c);g.destroy()}if(d.warning){i(b,d.warning,"warning")}k(a,!1);m(a)})})});r(a,function(){g.destroy();p(b,e);m(a)})},t=function(a,b,c){var e=a.querySelector(h.regions.imagehandler),f=a.querySelector(h.regions.hiddenFormField),g=c.target.files[0];if(!g.type.match("image.*")){return}var j=a.getAttribute("data-currentimage");if(""===j){j=a.getAttribute("data-defaultimage")}var l=new FileReader;l.onload=function(){var c=l.result;if(g.size>b){var t={size:o(b),file:g.name};(0,d.get_string)("maxbytesfile","error",t).done(function(a){i(e,a)});return}var h=document.createElement("img");h.setAttribute("src",c);h.addEventListener("load",function(){if(512>h.naturalWidth){(0,d.get_string)("resolutionlow","error").done(function(a){i(e,a)})}});p(e,c);var s={imagefilename:g.name,imagedata:c.split("base64,")[1],cropped:0,component:a.getAttribute("data-component"),filearea:a.getAttribute("data-filearea"),contextid:a.getAttribute("data-contextid"),draftitemid:a.getAttribute("data-draftitemid")};q(a,(0,d.get_string)("save","admin"),function(){k(a,!0);n({params:s}).then(function(b){if(b.success){a.setAttribute("data-currentimage",b.fileurl);j=b.fileurl}if(b.warning){i(e,b.warning,"warning")}if(f){f.value=s.draftitemid}k(a,!1);m(a)})});r(a,function(){p(e,j);m(a)})};l.readAsDataURL(g)},u=function(a){var b=a.querySelector(h.actions.deleteimage),c=a.querySelector(h.regions.hiddenFormField);if(!b.classList.contains(h.classes.enabled)){return""}var e=a.getAttribute("data-defaultimage"),f=a.querySelector(h.regions.imagehandler),g={imagedata:"",imagefilename:"",cropped:0,component:a.getAttribute("data-component"),filearea:a.getAttribute("data-filearea"),contextid:a.getAttribute("data-contextid"),draftitemid:a.getAttribute("data-draftitemid"),delete:1};q(a,(0,d.get_string)("delete","moodle"),function(){k(a,!0);n({params:g}).then(function(b){if(b.success){p(f,e);a.setAttribute("data-currentimage","")}if(c){c.value=-1}k(a,!1);m(a)})});r(a,function(){m(a)})};a.init=function init(a,b){var c=a.querySelector(h.actions.cropimage),d=a.querySelector(h.actions.uploadimage),e=a.querySelector(h.actions.deleteimage),f=a.querySelector(h.regions.imagecontrols);c.addEventListener("click",function(b){s(a);b.preventDefault()});d.addEventListener("change",function(c){t(a,b,c);c.preventDefault()});e.addEventListener("click",function(b){u(a);b.preventDefault()});m(a);f.classList.add("js-enabled")}});
//# sourceMappingURL=image_editable.min.js.map
